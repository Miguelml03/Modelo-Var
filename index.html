<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Econ√≥mico VAR: Suiza vs Per√∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --success: #27ae60;
            --bg: #ecf0f1;
            --card: #ffffff;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        
        /* Header */
        .header { grid-column: 1 / -1; background: var(--primary); color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-size: 1.8rem; }
        .header .badge { background: var(--accent); padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; }

        /* Sidebar */
        .sidebar { background: var(--card); padding: 20px; border-radius: 12px; height: fit-content; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* BOT√ìN M√ÅGICO */
        #btn-load {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white; border: none; width: 100%; padding: 18px; 
            border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        #btn-load:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(230, 126, 34, 0.5); }
        #btn-load:active { transform: scale(0.98); }

        /* Controles */
        .control-section { opacity: 0.5; pointer-events: none; transition: opacity 0.5s; }
        .control-group { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--primary); font-size: 0.9rem; }
        select, input[type="number"] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #bdc3c7; background: #f9f9f9; }

        /* Sliders */
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--accent); }
        .slider-val { float: right; color: var(--accent); font-weight: bold; }

        /* Main Content */
        .main { background: var(--card); padding: 25px; border-radius: 12px; min-height: 650px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* Tabs */
        .tabs { display: flex; gap: 15px; border-bottom: 2px solid #f0f0f0; margin-bottom: 25px; }
        .tab { padding: 12px 20px; cursor: pointer; font-weight: 600; color: #95a5a6; transition: 0.3s; position: relative; }
        .tab:hover { color: var(--accent); }
        .tab.active { color: var(--accent); }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: var(--accent); }

        /* Views */
        .view { display: none; animation: fadeIn 0.5s; }
        .view.active { display: block; }
        .chart-box { position: relative; height: 450px; width: 100%; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1>üìä Simulador Econ√≥mico Interactivo</h1>
        <div style="margin-top:5px; opacity:0.9;">Modelo VAR: Suiza vs Per√∫ (1985 - 2021)</div>
    </div>
    <span class="badge">v3.0 Definitiva</span>
</div>

<div class="container">
    <div class="sidebar">
        <button id="btn-load" onclick="initSystem()">
            <span>üìÇ</span> Cargar Datos Hist√≥ricos
        </button>

        <div id="controls" class="control-section">
            <div class="control-group">
                <label>üìç Pa√≠s</label>
                <select id="country" onchange="updateAll()">
                    <option value="peru">üáµüá™ Per√∫</option>
                    <option value="suiza">üá®üá≠ Suiza</option>
                </select>
            </div>

            <div class="control-group" id="history-controls">
                <label>üìä Variable a Visualizar</label>
                <select id="var-select" onchange="updateHistory()">
                    <option value="1">PBI (Log)</option>
                    <option value="2">Renta de Recursos (% PBI)</option>
                    <option value="3">Inversi√≥n Extranjera (% PBI)</option>
                    <option value="4">Exportaciones (% PBI)</option>
                </select>
            </div>

            <div class="control-group" id="sim-controls" style="display:none;">
                <label>‚è≥ Horizonte de Simulaci√≥n</label>
                <input type="range" id="horizon" min="5" max="30" value="10" oninput="document.getElementById('hor-val').innerText = this.value + ' A√±os'; updateSimulation()">
                <div style="text-align:right; font-size:0.8rem; color:#7f8c8d;" id="hor-val">10 A√±os</div>
                
                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                
                <label>‚ö° Shocks (Impacto)</label>
                
                <div style="margin-bottom:10px;">
                    <label style="font-size:0.85rem;">Inversi√≥n (IED) <span id="val-ied" class="slider-val">0%</span></label>
                    <input type="range" id="shock-ied" min="-10" max="10" step="0.5" value="0" oninput="updateSimulation()">
                </div>
                
                <div style="margin-bottom:10px;">
                    <label style="font-size:0.85rem;">Renta Recursos <span id="val-renta" class="slider-val">0%</span></label>
                    <input type="range" id="shock-renta" min="-10" max="10" step="0.5" value="0" oninput="updateSimulation()">
                </div>

                <div style="margin-bottom:10px;">
                    <label style="font-size:0.85rem;">Exportaciones <span id="val-exp" class="slider-val">0%</span></label>
                    <input type="range" id="shock-exp" min="-10" max="10" step="0.5" value="0" oninput="updateSimulation()">
                </div>

                <button onclick="resetShocks()" style="width:100%; padding:8px; background:#95a5a6; color:white; border:none; border-radius:4px; cursor:pointer;">‚Ü∫ Resetear</button>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('tab-history')">1. Historia (1985-2021)</div>
            <div class="tab" onclick="switchTab('tab-irf')">2. Simulaci√≥n Shocks</div>
            <div class="tab" onclick="switchTab('tab-forecast')">3. Pron√≥stico Futuro</div>
        </div>

        <div id="tab-history" class="view active">
            <h3>üìà Evoluci√≥n Hist√≥rica Real</h3>
            <p>Datos extra√≠dos de tu archivo Excel. Muestra el comportamiento real de la econom√≠a.</p>
            <div class="chart-box">
                <canvas id="chartHistory"></canvas>
            </div>
        </div>

        <div id="tab-irf" class="view">
            <h3>‚ö° Respuesta Din√°mica ante Shocks</h3>
            <p>Simula un golpe a la econom√≠a en el a√±o 0 y observa la reacci√≥n.</p>
            <div class="chart-box">
                <canvas id="chartIRF"></canvas>
            </div>
        </div>

        <div id="tab-forecast" class="view">
            <h3>üîÆ Pron√≥stico Ceteris Paribus</h3>
            <p>Proyecci√≥n del PBI basada en la inercia del modelo VAR.</p>
            <div class="chart-box">
                <canvas id="chartForecast"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // === 1. BASE DE DATOS INCRUSTADA (Extracto completo) ===
    const DB = {
        suiza: {
            raw: [ // Year, PBI(log), Renta, IED, Exp
                [1985, 11.00, 0.04, 1.14, 47.7], [1986, 11.01, 0.03, 1.33, 43.9], [1987, 11.02, 0.03, 1.16, 41.2], 
                [1988, 11.04, 0.02, 0.18, 42.3], [1989, 11.08, 0.03, 1.19, 44.8], [1990, 11.10, 0.03, 2.08, 41.3],
                [1991, 11.08, 0.02, 1.05, 39.8], [1992, 11.07, 0.02, 0.40, 40.7], [1993, 11.06, 0.02, 0.62, 40.8],
                [1994, 11.07, 0.01, 1.22, 40.0], [1995, 11.06, 0.01, 1.17, 40.0], [1996, 11.06, 0.01, 1.43, 41.0],
                [1997, 11.08, 0.01, 2.84, 46.5], [1998, 11.11, 0.01, 3.73, 45.9], [1999, 11.12, 0.01, 4.88, 46.7],
                [2000, 11.16, 0.03, 8.26, 51.4], [2001, 11.17, 0.02, 3.40, 50.2], [2002, 11.16, 0.01, 2.67, 48.5],
                [2003, 11.15, 0.01, 5.44, 47.7], [2004, 11.17, 0.01, 1.75, 51.3], [2005, 11.19, 0.01, 0.63, 53.8],
                [2006, 11.22, 0.01, 12.1, 56.6], [2007, 11.25, 0.01, 9.92, 61.5], [2008, 11.27, 0.01, 0.52, 63.1],
                [2009, 11.23, 0.01, 8.59, 58.0], [2010, 11.25, 0.01, 2.95, 64.8], [2011, 11.26, 0.01, 2.90, 66.4],
                [2012, 11.26, 0.01, 5.81, 67.7], [2013, 11.27, 0.01, -3.5, 72.0], [2014, 11.28, 0.01, 2.89, 65.3],
                [2015, 11.28, 0.01, 17.1, 63.8], [2016, 11.29, 0.01, 24.2, 66.8], [2017, 11.30, 0.01, 20.6, 66.3],
                [2018, 11.32, 0.01, -22., 67.4], [2019, 11.32, 0.01, 2.82, 66.9], [2020, 11.29, 0.01, -32., 64.0],
                [2021, 11.34, 0.01, -15., 71.1]
            ],
            model: {
                coeffs: [[[-0.044, 0.598, -0.0003, 0.0005], [-0.052, -0.328, 0.00002, 0.0005], [97.60, 84.35, -0.583, -0.689], [-74.05, 53.41, 0.005, 0.063]]],
                const: [0.0098, -0.0009, -1.46, 1.42]
            }
        },
        peru: {
            raw: [
                [1985, 9.04, 10.49, 0.006, 26.1], [1986, 9.11, 4.49, 0.10, 16.4], [1987, 9.18, 5.56, 0.08, 12.6],
                [1988, 9.06, 15.46, 0.16, 15.0], [1989, 8.90, 14.81, 0.26, 11.3], [1990, 8.83, 9.33, 0.15, 15.6],
                [1991, 8.83, 3.44, -0.02, 12.2], [1992, 8.81, 2.84, -0.21, 12.5], [1993, 8.84, 2.26, 2.18, 12.4],
                [1994, 8.93, 3.01, 7.32, 12.7], [1995, 8.99, 3.19, 4.79, 12.6], [1996, 8.99, 2.80, 6.28, 13.3],
                [1997, 9.04, 2.59, 3.67, 14.4], [1998, 9.02, 1.33, 2.96, 13.7], [1999, 9.01, 2.05, 3.86, 15.4],
                [2000, 9.03, 3.00, 1.56, 16.7], [2001, 9.02, 1.87, 2.19, 16.6], [2002, 9.06, 2.00, 3.93, 17.2],
                [2003, 9.09, 3.00, 2.27, 19.0], [2004, 9.13, 6.23, 2.39, 22.9], [2005, 9.18, 7.82, 3.39, 26.8],
                [2006, 9.24, 13.43, 3.91, 30.5], [2007, 9.32, 14.21, 5.37, 31.5], [2008, 9.40, 12.02, 5.74, 29.7],
                [2009, 9.40, 8.92, 5.32, 26.4], [2010, 9.48, 11.21, 5.73, 27.8], [2011, 9.53, 12.76, 4.47, 30.5],
                [2012, 9.58, 9.99, 7.36, 27.4], [2013, 9.63, 7.65, 4.75, 24.8], [2014, 9.64, 5.66, 2.12, 22.6],
                [2015, 9.67, 3.91, 3.86, 21.2], [2016, 9.69, 4.40, 3.54, 22.6], [2017, 9.70, 5.89, 3.51, 24.7],
                [2018, 9.72, 5.95, 2.63, 25.1], [2019, 9.73, 2.49, 2.09, 24.0], [2020, 9.60, 3.97, 0.32, 23.0],
                [2021, 9.71, 12.72, 3.15, 29.2]
            ],
            model: {
                coeffs: [
                    [[-0.40, 0.01, 0.01, 0.00], [-57.6, 0.00, 0.87, 0.69], [-12.2, 0.44, -0.30, -0.16], [-38.2, 0.43, 0.50, 0.29]],
                    [[0.64, 0.00, -0.00, -0.01], [37.8, -0.64, 0.35, 0.42], [25.6, 0.60, -0.38, -0.56], [7.61, -0.16, 0.25, 0.07]]
                ],
                const: [0.040, -0.365, 1.45, 1.06]
            }
        }
    };

    let charts = {};
    let isLoaded = false;
    let currentTab = 'tab-history';

    // === 2. INICIALIZACI√ìN ===
    function initSystem() {
        if(isLoaded) return;
        const btn = document.getElementById('btn-load');
        btn.innerHTML = "‚è≥ Extrayendo datos...";
        btn.style.background = "#f39c12";

        setTimeout(() => {
            btn.innerHTML = "‚úÖ Base de Datos Cargada";
            btn.style.background = "#27ae60";
            
            // Activar UI
            document.getElementById('controls').style.opacity = "1";
            document.getElementById('controls').style.pointerEvents = "all";
            isLoaded = true;
            
            updateAll();
        }, 1000);
    }

    function updateAll() {
        if(!isLoaded) return;
        
        // Actualizar visualizaci√≥n seg√∫n Tab activa
        if(currentTab === 'tab-history') {
            document.getElementById('history-controls').style.display = 'block';
            document.getElementById('sim-controls').style.display = 'none';
            updateHistory();
        } else {
            document.getElementById('history-controls').style.display = 'none';
            document.getElementById('sim-controls').style.display = 'block';
            updateSimulation();
        }
    }

    // === 3. GR√ÅFICO HIST√ìRICO (BARRA INTERACTIVA) ===
    function updateHistory() {
        const country = document.getElementById('country').value;
        const varIdx = parseInt(document.getElementById('var-select').value);
        const raw = DB[country].raw;

        const labels = raw.map(r => r[0]); // A√±os
        const data = raw.map(r => r[varIdx]); // Columna seleccionada
        
        // Nombres bonitos
        const names = ["", "PBI (Log Natural)", "Renta de Recursos (% PBI)", "Inv. Extranjera Directa (% PBI)", "Exportaciones (% PBI)"];
        const colors = ["", "#2c3e50", "#e67e22", "#2980b9", "#27ae60"];

        drawBarChart('chartHistory', names[varIdx], labels, data, colors[varIdx]);
    }

    // === 4. SIMULACI√ìN VAR CON HORIZONTE ===
    function updateSimulation() {
        const country = document.getElementById('country').value;
        const horizon = parseInt(document.getElementById('horizon').value);
        
        // Sliders
        const ied = parseFloat(document.getElementById('shock-ied').value);
        const renta = parseFloat(document.getElementById('shock-renta').value);
        const exp = parseFloat(document.getElementById('shock-exp').value);

        // Update Text
        document.getElementById('val-ied').innerText = ied + "%";
        document.getElementById('val-renta').innerText = renta + "%";
        document.getElementById('val-exp').innerText = exp + "%";

        // --- Calcular IRF ---
        const irfData = simulateModel(country, {ied, renta, exp}, horizon, 'irf');
        drawLineChart('chartIRF', 'Respuesta PBI (%)', irfData.labels, irfData.values, '#8e44ad');

        // --- Calcular Pron√≥stico ---
        const forecastData = simulateModel(country, {ied:0, renta:0, exp:0}, horizon, 'forecast');
        drawLineChart('chartForecast', 'Pron√≥stico Crecimiento (%)', forecastData.labels, forecastData.values, '#16a085');
    }

    // Motor Matem√°tico VAR
    function simulateModel(country, shocks, steps, type) {
        const model = DB[country].model;
        let path = [];
        let labels = [];
        
        // Vector de Shock [PBI, Renta, IED, Exp]
        let shockVec = [0, shocks.renta, shocks.ied, shocks.exp];
        
        // Estado inicial
        let history = [];
        const lags = model.coeffs.length;
        
        // Inicializar historial
        // Si es forecast, tomamos los √∫ltimos datos reales (diferencias aprox para growth)
        if(type === 'forecast') {
            // Usar ultimos 2 a√±os de datos reales para inicializar inercia
            // Simplificado: Usamos una media m√≥vil de los ultimos 2 a√±os del raw data
            // para estimar el vector de diferencias inicial
            const raw = DB[country].raw;
            const last = raw[raw.length-1];
            const prev = raw[raw.length-2];
            let diff = [last[1]-prev[1], last[2]-prev[2], last[3]-prev[3], last[4]-prev[4]];
            for(let i=0; i<lags; i++) history.push(diff);
        } else {
            // IRF empieza de 0
            for(let i=0; i<lags; i++) history.push([0,0,0,0]);
        }

        for(let t=0; t<steps; t++) {
            let current = [0,0,0,0];
            
            // VAR: Y_t = C + A1*Y_t-1...
            for(let l=0; l<lags; l++) {
                let past = history[history.length - 1 - l];
                let A = model.coeffs[l];
                
                for(let r=0; r<4; r++) {
                    for(let c=0; c<4; c++) {
                        current[r] += A[r][c] * past[c];
                    }
                }
            }

            // Sumar constante (solo forecast)
            if(type === 'forecast') {
                for(let k=0; k<4; k++) current[k] += model.const[k];
            }

            // Aplicar Shock en t=0 (solo IRF)
            if(type === 'irf' && t===0) {
                for(let k=0; k<4; k++) current[k] += shockVec[k];
            }

            path.push(current[0] * 100); // Convertir a % visual
            history.push(current);
            labels.push(type === 'forecast' ? (2022 + t) : `t+${t}`);
        }

        return {values: path, labels: labels};
    }

    // === UTILIDADES DE GR√ÅFICOS (Chart.js) ===
    function drawBarChart(id, label, labels, data, color) {
        const ctx = document.getElementById(id).getContext('2d');
        if(charts[id]) charts[id].destroy();

        charts[id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: color,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + (label.includes('%') ? '%' : '');
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) { return value + (label.includes('%') ? '%' : ''); }
                        }
                    }
                }
            }
        });
    }

    function drawLineChart(id, label, labels, data, color) {
        const ctx = document.getElementById(id).getContext('2d');
        if(charts[id]) charts[id].destroy();

        charts[id] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '20',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        ticks: { callback: function(value) { return value + '%'; } }
                    }
                }
            }
        });
    }

    function switchTab(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        document.getElementById(id).classList.add('active');
        // Find trigger element logic simplified for inline onclick
        event.currentTarget.classList.add('active');
        
        currentTab = id;
        updateAll();
    }
    
    function resetShocks() {
        document.getElementById('shock-ied').value = 0;
        document.getElementById('shock-renta').value = 0;
        document.getElementById('shock-exp').value = 0;
        updateSimulation();
    }
</script>

</body>
</html>